<!doctype html>
<html lang="es">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administración · OPTOClock</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="container">
    <h2>Acceso administradores</h2>
    <div id="msg" class="message"></div>

    <form id="login" class="form-grid">
      <input id="l_email" type="email" placeholder="Email admin" required>
      <input id="l_pass" type="password" placeholder="Contraseña" required>
      <button>Entrar</button>
    </form>

    <div id="panel" class="panel" style="display:none;">
      <div class="card">
        <h3>Crear trabajador</h3>
        <form id="alta" class="form-grid">
          <input id="a_full" placeholder="Nombre completo" required>
          <input id="a_email" type="email" placeholder="Email" required>
          <input id="a_pass" type="text" placeholder="Contraseña inicial" required>
          <select id="a_company"><option value="visionacademy">visionacademy</option><option value="eyecare">eyecare</option></select>
          <input id="a_pos" placeholder="Puesto" required>
          <button>Crear trabajador</button>
        </form>
      </div>
      <div class="card">
        <h3>Últimos fichajes</h3>
        <button id="download-pdf" style="margin-bottom: 1rem;">Descargar PDF</button>
        <table id="entries-table">
          <thead>
            <tr>
              <th>Empleado</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Tipo</th>
              <th>Empresa</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
document.getElementById('download-pdf').addEventListener('click', async () => {
  if (!currentUser) {
    show('Primero inicia sesión como admin');
    return;
  }
  show('Generando PDF…');
  try {
    const response = await fetch(`/api/generate_report?admin_email=${currentUser.email}`);
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al generar el PDF');
    }
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `reporte-${currentUser.company.toLowerCase().replace(/\s/g, '-')}.pdf`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    show('PDF generado correctamente.', true);
  } catch (error) {
    show('Error: ' + error.message);
  }
});
let currentUser = null;
const M=document.getElementById('msg');
function show(s,ok=false){M.textContent=s;M.className = 'message ' + (ok ? 'success' : 'error');}

document.getElementById('login').addEventListener('submit', async (e)=>{
  e.preventDefault(); show('Comprobando…');
  const email = document.getElementById('l_email').value.trim();
  const password = document.getElementById('l_pass').value;
  try{
    const r=await fetch('/api/login_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Error en el login');
    if(!j.user?.is_admin) throw new Error('No es administrador');
    currentUser = j.user;
    show('Acceso concedido ✓', true);
    document.getElementById('login').style.display = 'none';
    document.getElementById('panel').style.display='block';
    document.getElementById('a_company').value = currentUser.company;
    document.getElementById('a_company').disabled = true;
    loadAdminReport(currentUser.email);
  }catch(err){ show('Error: '+err.message); }
});

async function loadAdminReport(admin_email) {
  try {
    const response = await fetch(`/api/admin_report?admin_email=${admin_email}`);
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || 'Error al cargar el reporte');
    }
    const tableBody = document.querySelector('#entries-table tbody');
    tableBody.innerHTML = '';
    data.entries.forEach(entry => {
      const row = `
        <tr>
          <td>${entry.user_name}</td>
          <td>${entry.date_es}</td>
          <td>${entry.time_es}</td>
          <td>${entry.entry_type}</td>
          <td>${entry.company}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  } catch (error) {
    show('Error: ' + error.message);
  }
}

document.getElementById('alta').addEventListener('submit', async (e)=>{
  e.preventDefault(); show('Creando trabajador…');
  if(!currentUser) return show('Primero inicia sesión como admin');
  const body={
    admin_email: currentUser.email,
    full_name: document.getElementById('a_full').value.trim(),
    email:     document.getElementById('a_email').value.trim(),
    password:  document.getElementById('a_pass').value,
    company:   currentUser.company,
    position:  document.getElementById('a_pos').value.trim()
  };
  try{
    const r=await fetch('/api/register_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const j = await r.json();
    if(!r.ok) throw new Error(j.error||'Error al crear trabajador');
    show('Trabajador creado ✓', true);
    e.target.reset();
  }catch(err){ show('Error: '+err.message); }
});
</script>
</body>
</html>
